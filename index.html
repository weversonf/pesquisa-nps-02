import React, { useState, useEffect, useMemo } from 'react';
import { 
  BarChart, 
  Bar, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer,
  Cell, 
  PieChart, 
  Pie
} from 'recharts';
import { 
  TrendingUp, 
  MessageSquare, 
  LogOut,
  UserPlus, 
  FileSpreadsheet,
  ShieldCheck,
  Plus,
  Gauge,
  Key,
  ChevronLeft,
  Trash2,
  Filter,
  Download,
  Pencil,
  X
} from 'lucide-react';

// URL DO SEU GOOGLE APPS SCRIPT
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcsfpw1_uglhD6JtF4jAvjJ4hqgnHTcgKL8CBtb_i6pRmck7POOBvuqYykjIIE9sLdyQ/exec';

const App = () => {
  const [view, setView] = useState('login'); 
  const [loading, setLoading] = useState(false);
  const [userProfile, setUserProfile] = useState(null);
  const [responses, setResponses] = useState([]);
  const [usersList, setUsersList] = useState([]);
  const [dbContratosGlobal, setDbContratosGlobal] = useState([]);
  const [exportMenuOpen, setExportMenuOpen] = useState(false);
  const [editingLogin, setEditingLogin] = useState(null);
  
  // Filtros Globais
  const [filters, setFilters] = useState({ 
    mes: 'Todos', 
    unidade: 'Todas', 
    cliente: 'Todos', 
    contrato: 'Todos'
  });

  // Filtros Locais para a Tabela de Comentários
  const [tableFilters, setTableFilters] = useState({
    mes: 'Todos',
    unidade: 'Todas',
    cliente: 'Todos'
  });

  const [loginData, setLoginData] = useState({ identifier: '', password: '' });
  const [newUser, setNewUser] = useState({ nome: '', email: '', tipo: 'Usuario', permissoes: '' });
  const [surveyData, setSurveyData] = useState({ mes: 'Fev 26', contrato: '', nota: null, feedback: '' });

  // RÉGUA TÉCNICA MAKRO
  const ZONA_COLORS = {
    critica: '#f14c4c',         
    aperfeicoamento: '#fbbd4c', 
    qualidade: '#34b474',       
    excelencia: '#048c7c'       
  };

  const getStatusColor = (score) => {
    if (score <= 0) return ZONA_COLORS.critica;
    if (score <= 50) return ZONA_COLORS.aperfeicoamento;
    if (score <= 75) return ZONA_COLORS.qualidade;
    return ZONA_COLORS.excelencia;
  };

  const getStatusLabel = (score) => {
    if (score <= 0) return "Zona Crítica";
    if (score <= 50) return "Zona de Aperfeiçoamento";
    if (score <= 75) return "Zona de Qualidade";
    return "Zona de Excelência";
  };

  const fetchFromGAS = async (params) => {
    const url = new URL(SCRIPT_URL);
    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
    const response = await fetch(url);
    return await response.json();
  };

  const handleLogin = async (e) => {
    if (e) e.preventDefault();
    if (!loginData.identifier || !loginData.password) return alert("Preencha os campos.");
    setLoading(true);
    try {
      const res = await fetchFromGAS({ action: 'login', user: loginData.identifier, pass: loginData.password });
      if (res.result === "success") {
        setUserProfile({ nome: res.nome, email: res.email, tipo: res.tipo, permissoes: res.permissoes || [] });
        setDbContratosGlobal(res.metrics?.listaContratos || []);
        setResponses(res.metrics?.baseDados || []);
        setUsersList(res.admData || []);
        setView(loginData.password === "12345" ? 'password' : 'dashboard');
      } else { alert("Acesso negado. Verifique seu login e senha."); }
    } catch (err) { alert("Erro na ligação com a base de dados."); }
    finally { setLoading(false); }
  };

  const saveSurvey = async (e) => {
    if (e) e.preventDefault();
    if (surveyData.nota === null) return alert("Selecione uma nota");
    setLoading(true);
    try {
      const contratoInfo = dbContratosGlobal.find(c => c.exibicao === surveyData.contrato);
      const params = {
        action: 'survey',
        'Mes Referente': surveyData.mes,
        'Nome do Contrato': surveyData.contrato,
        'Número do Contrato': contratoInfo?.numero || '',
        'Nota': surveyData.nota,
        'Feedback': surveyData.feedback,
        'Nome do Cliente': contratoInfo?.cliente || userProfile?.nome,
        'Email do Responsável': userProfile?.email,
        'Nome do Responsável': userProfile?.nome
      };
      await fetch(`${SCRIPT_URL}?${new URLSearchParams(params).toString()}`, { method: 'POST' });
      alert("Avaliação enviada!");
      window.location.reload();
    } catch (err) { alert("Erro ao gravar os dados."); }
    finally { setLoading(false); }
  };

  const manageUser = async (mode, loginTarget = null) => {
    setLoading(true);
    try {
      const action = mode === 'add' ? (editingLogin ? 'addUser' : 'addUser') : 'deleteUser';
      // No script GAS, o addUser geralmente lida com UPDATE se o login já existir
      const params = {
        action: action,
        nome: newUser.nome,
        login: loginTarget || newUser.email,
        tipo: newUser.tipo,
        permissoes: newUser.permissoes
      };
      const res = await fetch(`${SCRIPT_URL}?${new URLSearchParams(params).toString()}`, { method: 'POST' });
      const data = await res.json();
      if (data.result === "success") {
        alert(editingLogin ? "Usuário atualizado!" : "Operação concluída!");
        setEditingLogin(null);
        setNewUser({ nome: '', email: '', tipo: 'Usuario', permissoes: '' });
        window.location.reload();
      }
    } catch (err) { alert("Erro na gestão de usuários."); }
    finally { setLoading(false); }
  };

  const startEditUser = (u) => {
    setEditingLogin(u.login);
    setNewUser({
      nome: u.nome,
      email: u.login,
      tipo: u.tipo,
      permissoes: u.permissoes || ''
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const changePassword = async (e) => {
    if (e) e.preventDefault();
    const newPass = document.getElementById('new-password-field').value;
    if (!newPass || newPass.length < 4) return alert("Palavra-passe muito curta.");
    setLoading(true);
    try {
      await fetch(`${SCRIPT_URL}?action=changePass&user=${encodeURIComponent(userProfile.email)}&newPass=${encodeURIComponent(newPass)}`, { method: 'POST' });
      alert("Palavra-passe atualizada! Por favor, faça login novamente.");
      setView('login');
    } catch (err) { alert("Erro ao atualizar palavra-passe."); }
    finally { setLoading(false); }
  };

  const filteredData = useMemo(() => {
    return responses.filter(r => {
      const matchMes = filters.mes === 'Todos' || r.mes === filters.mes;
      const matchUnid = filters.unidade === 'Todas' || r.unidade === filters.unidade;
      const matchCli = filters.cliente === 'Todos' || r.cliente === filters.cliente;
      const matchCont = filters.contrato === 'Todos' || r.contrato === filters.contrato;
      
      let matchPerm = true;
      if (userProfile?.tipo === 'Usuario') {
        matchPerm = (userProfile.permissoes || []).includes(r.contrato) || (userProfile.permissoes || []).includes(r.unidade);
      }
      return matchMes && matchUnid && matchCli && matchCont && matchPerm;
    });
  }, [responses, filters, userProfile]);

  const tableData = useMemo(() => {
    return filteredData.filter(r => {
      const matchMes = tableFilters.mes === 'Todos' || r.mes === tableFilters.mes;
      const matchUnid = tableFilters.unidade === 'Todas' || r.unidade === tableFilters.unidade;
      const matchCli = tableFilters.cliente === 'Todos' || r.cliente === tableFilters.cliente;
      return matchMes && matchUnid && matchCli;
    });
  }, [filteredData, tableFilters]);

  const stats = useMemo(() => {
    const total = filteredData.length;
    if (total === 0) return { nps: 0, p: 0, n: 0, d: 0, total: 0 };
    const p = filteredData.filter(x => x.nota >= 9).length;
    const n = filteredData.filter(x => x.nota >= 7 && x.nota <= 8).length;
    const d = filteredData.filter(x => x.nota <= 6).length;
    return { nps: Math.round(((p - d) / total) * 100), p, n, d, total };
  }, [filteredData]);

  const monthlyNpsData = useMemo(() => {
    const uniqueMonths = [...new Set(responses.map(r => r.mes))].sort();
    return uniqueMonths.map(m => {
      const dMes = responses.filter(x => x.mes === m); 
      const p = dMes.filter(x => x.nota >= 9).length;
      const det = dMes.filter(x => x.nota <= 6).length;
      const nps = dMes.length > 0 ? Math.round(((p - det) / dMes.length) * 100) : 0;
      return { mes: m, score: nps };
    });
  }, [responses]);

  const RADIAN = Math.PI / 180;
  const renderNeedle = (value, cx, cy, iR, oR) => {
    const clampedValue = Math.max(-100, Math.min(100, value));
    const ang = 180 - ((clampedValue + 100) / 200) * 180; 
    const length = (iR + oR) / 2.2;
    const sin = Math.sin(-RADIAN * ang);
    const cos = Math.cos(-RADIAN * ang);
    const r = 6;
    const x0 = cx;
    const y0 = cy;
    const xba = x0 + r * sin;
    const yba = y0 - r * cos;
    const xbb = x0 - r * sin;
    const ybb = y0 + r * cos;
    const xp = x0 + length * cos;
    const yp = y0 + length * sin;
    return (
      <g key="needle">
        <circle cx={x0} cy={y0} r={r} fill="#fff" stroke="none" />
        <path d={`M${xba} ${yba}L${xbb} ${ybb}L${xp} ${yp}Z`} fill="#fff" stroke="none" />
      </g>
    );
  };

  const gaugeData = [
    { name: 'Crítica', value: 100, fill: ZONA_COLORS.critica },       
    { name: 'Aperfeiçoamento', value: 50, fill: ZONA_COLORS.aperfeicoamento }, 
    { name: 'Qualidade', value: 25, fill: ZONA_COLORS.qualidade },     
    { name: 'Excelência', value: 25, fill: ZONA_COLORS.excelencia }     
  ];

  // FUNÇÃO DE EXPORTAÇÃO MELHORADA
  const handleExport = (type) => {
    setExportMenuOpen(false);
    let dataToExport = [];
    let fileName = "NPS_Makro_Engenharia";

    if (type === 'all') {
      dataToExport = responses;
      fileName += "_Completo";
    } else if (type === 'filtered') {
      dataToExport = filteredData;
      fileName += "_Filtrado";
    } else if (type === 'month') {
      dataToExport = responses.filter(r => r.mes === filters.mes);
      fileName += `_Mes_${filters.mes.replace(' ', '_')}`;
    }

    if (dataToExport.length === 0) return alert("Nenhum dado para exportar com este critério.");

    const csvRows = [
      ["Data", "Mes", "Unidade", "Cliente", "Contrato", "Nota", "Feedback"],
      ...dataToExport.map(r => [r.data, r.mes, r.unidade, r.cliente, r.contrato, r.nota, r.feedback])
    ];
    
    const csvContent = "data:text/csv;charset=utf-8," + csvRows.map(e => e.join(",")).join("\n");
    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", `${fileName}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const colors = {
    bg: 'bg-[#010816]',
    glass: 'bg-white bg-opacity-5 backdrop-blur-xl border border-white border-opacity-10',
    text: 'text-slate-100'
  };

  return (
    <div className={`min-h-screen ${colors.bg} ${colors.text} font-['Ubuntu'] selection:bg-red-500`}>
      <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet" />
      
      <header className="p-6 flex flex-col items-center border-b border-white border-opacity-10 bg-black bg-opacity-20 sticky top-0 z-50 backdrop-blur-md">
        <img src="https://makroengenharia.com.br/wp-content/uploads/2023/03/logo-1.png" alt="Makro" className="h-10 mb-2" />
        <div className="text-[10px] tracking-[4px] opacity-60 font-bold uppercase">Painel NPS | Makro Engenharia</div>
      </header>

      <main className="max-w-6xl mx-auto p-4 md:p-8">
        {loading && (
          <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center backdrop-blur-sm">
            <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-red-600"></div>
          </div>
        )}

        {view === 'login' && (
          <div className="flex flex-col items-center mt-20 animate-fadeIn">
            <form onSubmit={handleLogin} className={`w-full max-w-sm p-8 rounded-3xl ${colors.glass} shadow-2xl`}>
              <h2 className="text-2xl font-bold text-center mb-8 tracking-tighter uppercase">Acesso Makro</h2>
              <div className="space-y-4">
                <div>
                  <label className="text-[10px] uppercase font-bold opacity-40 mb-1 ml-1">Login</label>
                  <input 
                    className="w-full bg-white/10 p-4 rounded-xl outline-none" 
                    placeholder="Seu login" 
                    type="text"
                    required
                    onChange={(e) => setLoginData({...loginData, identifier: e.target.value})} 
                  />
                </div>
                <div>
                  <label className="text-[10px] uppercase font-bold opacity-40 mb-1 ml-1">Palavra-passe</label>
                  <input 
                    type="password" 
                    className="w-full bg-white/10 p-4 rounded-xl outline-none" 
                    placeholder="••••••••" 
                    required
                    onChange={(e) => setLoginData({...loginData, password: e.target.value})} 
                  />
                </div>
                <button type="submit" className="w-full bg-red-600 p-4 rounded-xl font-bold uppercase hover:bg-red-700 transition">Entrar no Painel</button>
              </div>
            </form>
          </div>
        )}

        {view === 'dashboard' && (
          <div className="space-y-6 animate-fadeIn">
            <div className="flex justify-between items-center mb-8">
              <div className="flex items-center gap-3">
                <ShieldCheck className="text-red-600" size={32}/>
                <div>
                  <h3 className="text-xs font-bold opacity-50 uppercase tracking-widest">{userProfile?.tipo}</h3>
                  <p className="font-bold text-xl tracking-tight">{userProfile?.nome}</p>
                </div>
              </div>
              <div className="flex gap-2 relative">
                {userProfile?.tipo === 'ADM MASTER' && (
                  <button onClick={() => setView('users')} className="p-2 bg-blue-600 rounded-lg shadow-lg hover:bg-blue-700 transition" title="Usuários"><UserPlus size={18}/></button>
                )}
                
                {/* BOTÃO DE EXCEL COM MENU DROP DOWN */}
                <div className="relative">
                  <button 
                    onClick={() => setExportMenuOpen(!exportMenuOpen)} 
                    className="p-2 bg-green-600 rounded-lg shadow-lg hover:bg-green-700 transition flex items-center gap-1" 
                    title="Exportar Dados"
                  >
                    <FileSpreadsheet size={18}/>
                    <Plus size={10} className={`transition-transform ${exportMenuOpen ? 'rotate-45' : ''}`}/>
                  </button>
                  
                  {exportMenuOpen && (
                    <div className="absolute right-0 mt-2 w-48 rounded-xl bg-[#010816] border border-white/10 shadow-2xl z-[60] overflow-hidden animate-fadeIn">
                      <div className="p-2 text-[8px] uppercase font-bold opacity-30 tracking-widest bg-white/5">Opções de Extração</div>
                      <button onClick={() => handleExport('filtered')} className="w-full text-left p-3 text-[10px] font-bold uppercase hover:bg-white/5 transition flex items-center gap-2">
                        <Filter size={14} className="text-green-500"/> Exportar Filtrado
                      </button>
                      <button onClick={() => handleExport('all')} className="w-full text-left p-3 text-[10px] font-bold uppercase hover:bg-white/5 transition border-t border-white/5 flex items-center gap-2">
                        <Download size={14} className="text-blue-500"/> Exportar Tudo
                      </button>
                      {filters.mes !== 'Todos' && (
                        <button onClick={() => handleExport('month')} className="w-full text-left p-3 text-[10px] font-bold uppercase hover:bg-white/5 transition border-t border-white/5 flex items-center gap-2">
                          <MessageSquare size={14} className="text-orange-500"/> Mês: {filters.mes}
                        </button>
                      )}
                    </div>
                  )}
                </div>

                <button onClick={() => setView('password')} className="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition" title="Mudar Palavra-passe"><Key size={18}/></button>
                <button onClick={() => setView('survey')} className="p-2 bg-red-600 rounded-lg shadow-lg shadow-red-600/20 active:scale-90 transition" title="Nova Avaliação"><Plus size={18}/></button>
                <button onClick={() => window.location.reload()} className="p-2 bg-white/5 rounded-lg hover:bg-red-600/20 transition" title="Sair"><LogOut size={18}/></button>
              </div>
            </div>

            <div className={`grid grid-cols-2 md:grid-cols-4 gap-4 p-4 rounded-2xl ${colors.glass}`}>
              <div>
                <label className="text-[9px] uppercase font-bold opacity-40 mb-1 block">Mês (Global)</label>
                <select className="w-full bg-white/5 p-2 rounded-lg text-xs outline-none border border-white/10" value={filters.mes} onChange={(e) => setFilters({...filters, mes: e.target.value})}>
                  <option value="Todos">Todos</option>
                  {[...new Set(responses.map(r => r.mes))].filter(Boolean).sort().map(val => <option key={val} value={val} className="bg-slate-900">{val}</option>)}
                </select>
              </div>
              <div>
                <label className="text-[9px] uppercase font-bold opacity-40 mb-1 block">Unidade</label>
                <select className="w-full bg-white/5 p-2 rounded-lg text-xs outline-none border border-white/10" value={filters.unidade} onChange={(e) => setFilters({...filters, unidade: e.target.value})}>
                  <option value="Todas">Todas</option>
                  {[...new Set(responses.map(r => r.unidade))].filter(Boolean).sort().map(val => <option key={val} value={val} className="bg-slate-900">{val}</option>)}
                </select>
              </div>
              <div>
                <label className="text-[9px] uppercase font-bold opacity-40 mb-1 block">Cliente</label>
                <select className="w-full bg-white/5 p-2 rounded-lg text-xs outline-none border border-white/10" value={filters.cliente} onChange={(e) => setFilters({...filters, cliente: e.target.value})}>
                  <option value="Todos">Todos</option>
                  {[...new Set(responses.map(r => r.cliente))].filter(Boolean).sort().map(val => <option key={val} value={val} className="bg-slate-900">{val}</option>)}
                </select>
              </div>
              <div>
                <label className="text-[9px] uppercase font-bold opacity-40 mb-1 block">Contrato</label>
                <select className="w-full bg-white/5 p-2 rounded-lg text-xs outline-none border border-white/10" value={filters.contrato} onChange={(e) => setFilters({...filters, contrato: e.target.value})}>
                  <option value="Todos">Todos</option>
                  {[...new Set(responses.map(r => r.contrato))].filter(Boolean).sort().map(val => <option key={val} value={val} className="bg-slate-900">{val}</option>)}
                </select>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* HISTÓRICO NPS */}
              <div className={`lg:col-span-2 p-6 rounded-3xl ${colors.glass} min-h-[420px]`}>
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                  <h4 className="font-bold text-xs uppercase opacity-60 flex items-center gap-2"><TrendingUp size={16}/> Histórico NPS</h4>
                  <div className="flex flex-wrap gap-x-4 gap-y-2 text-[8px] font-bold uppercase tracking-wider">
                    {gaugeData.map((zone) => (
                      <span key={zone.name} className="flex items-center gap-1" style={{color: zone.fill}}>
                        <div className="w-2 h-2 rounded-full shadow-sm" style={{backgroundColor: zone.fill}}/> {zone.name}
                      </span>
                    ))}
                  </div>
                </div>
                <div className="h-[300px]">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={monthlyNpsData}>
                      <CartesianGrid strokeDasharray="3 3" strokeOpacity={0.05} vertical={false}/>
                      <XAxis dataKey="mes" stroke="#ffffff22" fontSize={10}/>
                      <YAxis stroke="#ffffff22" domain={[-100, 100]} fontSize={10}/>
                      <Tooltip 
                        cursor={{fill: '#ffffff08'}} 
                        contentStyle={{backgroundColor: '#010816', border: '1px solid #ffffff11', borderRadius: '12px', fontSize: '10px'}}
                      />
                      <Bar dataKey="score" radius={[6, 6, 0, 0]}>
                        {monthlyNpsData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={getStatusColor(entry.score)} />
                        ))}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* NPS ATUAL (VELOCÍMETRO) */}
              <div className={`p-6 rounded-3xl ${colors.glass} flex flex-col items-center relative overflow-hidden`}>
                <div className="w-full mb-2 flex justify-between items-start">
                  <h4 className="font-bold text-xs uppercase opacity-60 flex items-center gap-2"><Gauge size={16}/> NPS Atual</h4>
                </div>

                <div className="text-center mb-4 animate-fadeIn">
                  <h2 className="text-6xl font-black tracking-tighter" style={{ color: getStatusColor(stats.nps) }}>
                    {stats.nps}
                  </h2>
                  <p className="text-[11px] font-bold uppercase opacity-80 mt-1 tracking-widest" style={{ color: getStatusColor(stats.nps) }}>
                    {getStatusLabel(stats.nps)}
                  </p>
                </div>

                <div className="w-full h-[220px] flex items-center justify-center">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Pie
                        data={gaugeData}
                        cx="50%"
                        cy="80%"
                        startAngle={180}
                        endAngle={0}
                        innerRadius="65%"
                        outerRadius="95%"
                        paddingAngle={0}
                        dataKey="value"
                        stroke="none"
                      >
                        {gaugeData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={entry.fill} />
                        ))}
                      </Pie>
                      {renderNeedle(stats.nps, 137, 176, 90, 130)}
                    </PieChart>
                  </ResponsiveContainer>
                </div>

                <div className="w-full flex justify-between px-10 text-[9px] font-bold opacity-30 mt-[-20px] uppercase tracking-widest">
                  <span>-100</span>
                  <span>0</span>
                  <span>50</span>
                  <span>75</span>
                  <span>100</span>
                </div>
              </div>
            </div>

            {/* TABELA VOZ DO CLIENTE COM FILTROS LOCAIS */}
            <div className={`p-6 rounded-3xl ${colors.glass} overflow-hidden`}>
              <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <h4 className="font-bold text-xs uppercase opacity-60 flex items-center gap-2">
                  <MessageSquare size={16}/> Voz do Cliente (Feedbacks Técnicos)
                </h4>
                
                <div className="flex flex-wrap items-center gap-3 bg-white/5 p-2 rounded-xl border border-white/10">
                  <div className="flex items-center gap-2 border-r border-white/10 pr-3">
                    <Filter size={12} className="text-red-500 opacity-70"/>
                    <span className="text-[9px] uppercase font-black opacity-40 tracking-wider">Mês:</span>
                    <select 
                      className="bg-transparent text-[11px] font-bold outline-none cursor-pointer text-white"
                      value={tableFilters.mes}
                      onChange={(e) => setTableFilters({...tableFilters, mes: e.target.value})}
                    >
                      <option value="Todos" className="bg-slate-900">Todos</option>
                      {[...new Set(responses.map(r => r.mes))].filter(Boolean).sort().map(val => (
                        <option key={val} value={val} className="bg-slate-900">{val}</option>
                      ))}
                    </select>
                  </div>

                  <div className="flex items-center gap-2 border-r border-white/10 pr-3">
                    <span className="text-[9px] uppercase font-black opacity-40 tracking-wider">Unidade:</span>
                    <select 
                      className="bg-transparent text-[11px] font-bold outline-none cursor-pointer text-white"
                      value={tableFilters.unidade}
                      onChange={(e) => setTableFilters({...tableFilters, unidade: e.target.value})}
                    >
                      <option value="Todas" className="bg-slate-900">Todas</option>
                      {[...new Set(responses.map(r => r.unidade))].filter(Boolean).sort().map(val => (
                        <option key={val} value={val} className="bg-slate-900">{val}</option>
                      ))}
                    </select>
                  </div>

                  <div className="flex items-center gap-2">
                    <span className="text-[9px] uppercase font-black opacity-40 tracking-wider">Cliente:</span>
                    <select 
                      className="bg-transparent text-[11px] font-bold outline-none cursor-pointer text-white"
                      value={tableFilters.cliente}
                      onChange={(e) => setTableFilters({...tableFilters, cliente: e.target.value})}
                    >
                      <option value="Todos" className="bg-slate-900">Todos</option>
                      {[...new Set(responses.map(r => r.cliente))].filter(Boolean).sort().map(val => (
                        <option key={val} value={val} className="bg-slate-900">{val}</option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>
              
              <div className="overflow-x-auto custom-scrollbar">
                <table className="w-full text-left border-collapse">
                  <thead>
                    <tr className="bg-white/5 text-[9px] font-bold uppercase text-red-500 tracking-widest">
                      <th className="p-4 rounded-l-xl">Data</th>
                      <th className="p-4">Contrato</th>
                      <th className="p-4">Nome Contrato</th>
                      <th className="p-4">Cliente / Empresa</th>
                      <th className="p-4 text-center">Nota</th>
                      <th className="p-4 rounded-r-xl">Comentário / Feedback</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-white/5">
                    {tableData.length === 0 ? (
                      <tr>
                        <td colSpan="6" className="p-20 text-center opacity-20 uppercase font-bold text-xs">Nenhum registo encontrado com os filtros locais</td>
                      </tr>
                    ) : (
                      tableData.map((r, i) => (
                        <tr key={i} className="hover:bg-white/5 transition-colors group">
                          <td className="p-4 text-[10px] whitespace-nowrap opacity-60">
                            {r.data ? new Date(r.data).toLocaleDateString('pt-BR') : '—'}
                          </td>
                          <td className="p-4 text-[11px] font-bold text-blue-400">
                            {r['Número do Contrato'] || r.contrato?.split('/')[0] || '—'}
                          </td>
                          <td className="p-4 text-[10px] opacity-80 uppercase max-w-[150px] truncate">
                            {r.contrato || '—'}
                          </td>
                          <td className="p-4 text-[11px] font-bold uppercase truncate max-w-[180px]">
                            {r.cliente || '—'}
                          </td>
                          <td className="p-4 text-center">
                            <span className="inline-block px-3 py-1 rounded-lg text-[11px] font-black" style={{ 
                              backgroundColor: `${getStatusColor(r.nota * 10 - 25)}22`,
                              color: getStatusColor(r.nota * 10 - 25)
                            }}>
                              {r.nota}
                            </span>
                          </td>
                          <td className="p-4 text-[11px] italic opacity-70 group-hover:opacity-100 transition-opacity leading-relaxed max-w-[300px]">
                            "{r.feedback || <span className="opacity-30">Sem comentário</span>}"
                          </td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* VIEW: GESTÃO DE USUÁRIOS */}
        {view === 'users' && (
          <div className="space-y-6 animate-fadeIn">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold uppercase tracking-tight flex items-center gap-2">
                <UserPlus className="text-blue-500"/> Gestão de Usuários
              </h2>
              <button onClick={() => setView('dashboard')} className="px-4 py-2 bg-white/10 rounded-lg text-xs font-bold hover:bg-white/20 flex items-center gap-2">
                <ChevronLeft size={14}/> Voltar ao Painel
              </button>
            </div>

            <div className={`p-6 rounded-3xl ${colors.glass} border-l-4 ${editingLogin ? 'border-blue-500' : 'border-transparent'} transition-all`}>
              <div className="flex justify-between items-center mb-4">
                <h4 className="text-[10px] uppercase font-bold opacity-40 tracking-widest">
                  {editingLogin ? `Editar Usuário: ${editingLogin}` : 'Novo Cadastro'}
                </h4>
                {editingLogin && (
                  <button 
                    onClick={() => { setEditingLogin(null); setNewUser({ nome: '', email: '', tipo: 'Usuario', permissoes: '' }); }}
                    className="p-1 hover:bg-white/10 rounded-full text-red-400 transition"
                  >
                    <X size={16}/>
                  </button>
                )}
              </div>
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input 
                  value={newUser.nome}
                  placeholder="Nome Completo" 
                  className="bg-white/5 p-3 rounded-lg border border-white/10 outline-none text-sm focus:border-blue-500 transition" 
                  onChange={e => setNewUser({...newUser, nome: e.target.value})}
                />
                <input 
                  value={newUser.email}
                  placeholder="Login de Acesso" 
                  disabled={!!editingLogin}
                  className={`bg-white/5 p-3 rounded-lg border border-white/10 outline-none text-sm focus:border-blue-500 transition ${editingLogin ? 'opacity-50' : ''}`} 
                  onChange={e => setNewUser({...newUser, email: e.target.value})}
                />
                <select 
                  value={newUser.tipo}
                  className="bg-white/5 p-3 rounded-lg border border-white/10 outline-none text-sm focus:border-blue-500" 
                  onChange={e => setNewUser({...newUser, tipo: e.target.value})}
                >
                  <option value="Usuario" className="bg-slate-900">Usuário Comum</option>
                  <option value="Gerente" className="bg-slate-900">Gerente</option>
                  <option value="ADM" className="bg-slate-900">Administrador</option>
                  <option value="ADM MASTER" className="bg-slate-900">ADM Master</option>
                </select>
                <input 
                  value={newUser.permissoes}
                  placeholder="Contratos (Ex: CTR001,CTR002)" 
                  className="bg-white/5 p-3 rounded-lg border border-white/10 outline-none text-sm focus:border-blue-500 transition" 
                  onChange={e => setNewUser({...newUser, permissoes: e.target.value})}
                />
              </div>
              <div className="flex gap-3 mt-4">
                <button 
                  onClick={() => manageUser('add')} 
                  className={`px-6 py-3 rounded-xl font-bold uppercase text-xs shadow-lg transition active:scale-95 ${editingLogin ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'}`}
                >
                  {editingLogin ? 'Atualizar Acesso' : 'Salvar Novo Acesso'}
                </button>
                {editingLogin && (
                   <button 
                   onClick={() => { setEditingLogin(null); setNewUser({ nome: '', email: '', tipo: 'Usuario', permissoes: '' }); }}
                   className="px-6 py-3 bg-white/5 rounded-xl font-bold uppercase text-xs hover:bg-white/10 transition"
                 >
                   Cancelar
                 </button>
                )}
              </div>
            </div>

            <div className={`rounded-3xl overflow-hidden ${colors.glass}`}>
              <table className="w-full text-xs text-left">
                <thead className="bg-white/10 text-blue-400 font-bold uppercase text-[10px]">
                  <tr>
                    <th className="p-4">Nome</th>
                    <th className="p-4">Login</th>
                    <th className="p-4">Tipo</th>
                    <th className="p-4 text-center">Ações</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-white/5">
                  {usersList.map(u => (
                    <tr key={u.login} className={`hover:bg-white/5 transition-colors group ${editingLogin === u.login ? 'bg-blue-500/10' : ''}`}>
                      <td className="p-4 font-bold">{u.nome}</td>
                      <td className="p-4 opacity-50">{u.login}</td>
                      <td className="p-4"><span className="px-2 py-1 rounded bg-blue-500/10 text-blue-400 text-[10px] font-bold uppercase">{u.tipo}</span></td>
                      <td className="p-4 text-center">
                        <div className="flex items-center justify-center gap-3">
                          <button 
                            className="text-blue-400 hover:text-blue-300 transition" 
                            onClick={() => startEditUser(u)}
                            title="Editar Usuário"
                          >
                            <Pencil size={16}/>
                          </button>
                          <button 
                            className="text-red-500 hover:text-red-400 transition" 
                            onClick={() => { if(confirm('Deseja realmente excluir este acesso?')) manageUser('delete', u.login); }}
                            title="Excluir Usuário"
                          >
                            <Trash2 size={16}/>
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* VIEW: ALTERAR PALAVRA-PASSE */}
        {view === 'password' && (
          <div className="flex flex-col items-center mt-20 animate-fadeIn">
            <form onSubmit={changePassword} className={`w-full max-w-sm p-8 rounded-3xl ${colors.glass} border-t-8 border-orange-500 shadow-2xl`}>
              <div className="flex flex-col items-center mb-6">
                <div className="p-4 bg-orange-600/20 rounded-full mb-4"><Key className="text-orange-500" size={32}/></div>
                <h2 className="text-xl font-bold text-center tracking-tight">Alterar Palavra-passe</h2>
                <p className="text-center text-xs opacity-50 mt-2 leading-relaxed">Defina uma nova palavra-passe corporativa.</p>
              </div>
              <div className="space-y-4">
                <input 
                  id="new-password-field"
                  className="w-full bg-white/10 p-4 rounded-xl outline-none focus:ring-2 ring-orange-500 transition-all" 
                  type="password" 
                  placeholder="Nova Palavra-passe" 
                  required 
                />
                <button type="submit" className="w-full bg-orange-600 p-4 rounded-xl font-bold uppercase shadow-lg shadow-orange-900/20 active:scale-95 transition">Atualizar Agora</button>
                <button type="button" onClick={() => setView('dashboard')} className="w-full text-xs font-bold opacity-30 hover:opacity-100 transition uppercase">Cancelar</button>
              </div>
            </form>
          </div>
        )}

        {/* VIEW: NOVA PESQUISA (SURVEY) */}
        {view === 'survey' && (
          <div className="max-w-xl mx-auto animate-fadeIn">
            <form onSubmit={saveSurvey} className={`p-8 rounded-3xl ${colors.glass} border-t-8 border-red-600 shadow-2xl`}>
              <div className="flex justify-between items-center mb-8">
                <h2 className="text-2xl font-bold tracking-tight">AVALIAÇÃO TÉCNICA</h2>
                <button type="button" onClick={() => setView('dashboard')} className="text-white/40 uppercase text-[10px] font-bold hover:text-white transition">Voltar</button>
              </div>
              <div className="space-y-6">
                <div>
                  <label className="text-[9px] font-bold uppercase opacity-40 ml-1 mb-1 block tracking-widest">Mês de Referência</label>
                  <select className="w-full bg-white/5 p-4 rounded-xl border border-white/10 outline-none text-sm" required onChange={e => setSurveyData({...surveyData, mes: e.target.value})}>
                    <option value="Fev 26">Fevereiro 2026</option><option value="Mar 26">Março 2026</option>
                  </select>
                </div>
                <div>
                  <label className="text-[9px] font-bold uppercase opacity-40 ml-1 mb-1 block tracking-widest">Contrato / Projeto</label>
                  <select className="w-full bg-white/5 p-4 rounded-xl border border-white/10 outline-none text-sm" required onChange={e => setSurveyData({...surveyData, contrato: e.target.value})}>
                    <option value="">Selecione o Contrato...</option>
                    {dbContratosGlobal.map(c => <option key={c.exibicao} value={c.exibicao} className="bg-slate-900">{c.exibicao}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-[9px] font-bold uppercase opacity-40 ml-1 mb-2 block tracking-widest">Satisfação Geral (0 a 10)</label>
                  <div className="flex justify-between gap-1 overflow-x-auto pb-2 custom-scrollbar">
                    {[...Array(11).keys()].map(n => (
                      <button key={n} type="button" onClick={() => setSurveyData({...surveyData, nota: n})}
                        className={`w-10 h-10 min-w-[35px] rounded-lg font-bold text-sm transition-all ${surveyData.nota === n ? 'bg-red-600 text-white scale-110 shadow-lg' : 'bg-white/5 border border-white/10 text-white/40'}`}>
                        {n}
                      </button>
                    ))}
                  </div>
                </div>
                <textarea className="w-full bg-white/5 p-4 rounded-xl border border-white/10 outline-none h-28 text-sm resize-none" placeholder="O que motivou a sua nota?" onChange={e => setSurveyData({...surveyData, feedback: e.target.value})} />
                <button type="submit" className="w-full bg-red-600 p-4 rounded-2xl font-bold uppercase shadow-xl hover:bg-red-700 transition active:scale-95">Registar Avaliação</button>
              </div>
            </form>
          </div>
        )}
      </main>

      <footer className="mt-20 p-10 text-center opacity-30 text-[9px] uppercase font-bold tracking-[4px]">Marketing & Qualidade | Makro Engenharia © 2026</footer>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.2s ease forwards; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #ED1C24; }
        
        table { border-spacing: 0 8px; border-collapse: separate; }
        tbody tr { background: rgba(255,255,255,0.02); }
        tbody tr:hover { background: rgba(255,255,255,0.05); }
        th { border: none; }
        td { border: none; }
      `}} />
    </div>
  );
};

export default App;
