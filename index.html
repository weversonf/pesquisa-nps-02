<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema NPS | Makro Engenharia</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root {
            --azul-profundo: #011f42; --azul-makro: #023F88;
            --vermelho-nps: #ED1C24; --laranja-nps: #FF8C00; --verde-nps: #28a745; --azul-nps: #007bff;
            --branco: #FFFFFF; --glass: rgba(255, 255, 255, 0.05); --glass-border: rgba(255, 255, 255, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        body { background: radial-gradient(circle at top right, var(--azul-makro), var(--azul-profundo)); background-attachment: fixed; color: var(--branco); min-height: 100vh; }
        header { padding: 1.5rem; text-align: center; background: rgba(0, 0, 0, 0.3); border-bottom: 1px solid var(--glass-border); }
        .container { padding: 1.5rem; max-width: 950px; margin: 0 auto; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--glass); backdrop-filter: blur(15px); padding: 1.5rem; border-radius: 20px; border: 1px solid var(--glass-border); margin-bottom: 20px; }
        .filter-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 20px; }
        select, input, textarea {
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid var(--glass-border); 
            padding: 10px; 
            border-radius: 8px; 
            color: #cccccc; 
            width: 100%; 
            outline: none; 
            font-size: 11px; 
            margin-bottom: 20px;
        }
        #btnLogin { margin-top: 10px; }
        select option { background: var(--azul-profundo); color: #cccccc; }
        label { font-size: 9px; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; display: block; opacity: 0.7; }
        .grid-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .card-metric { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--glass-border); }
        .card-metric h2 { font-size: 24px; font-weight: 900; }
        .btn { background: linear-gradient(90deg, #ED1C24, #b31217); color: white; padding: 1rem; border-radius: 12px; border: none; width: 100%; font-weight: 900; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .nps-container { display: flex; justify-content: space-between; gap: 4px; margin: 10px 0 20px; }
        .nps-item input { display: none; }
        .nps-item label { display: flex; align-items: center; justify-content: center; height: 35px; width: 100%; background: rgba(255,255,255,0.1); border-radius: 5px; cursor: pointer; font-size: 11px; border: 1px solid var(--glass-border); }
        .nps-item input:checked + label { background: var(--vermelho-nps); border-color: #fff; transform: scale(1.1); font-weight: bold; }
        footer { text-align: center; padding: 2rem; font-size: 0.6rem; color: rgba(255,255,255,0.3); letter-spacing: 2px; }
    </style>
</head>
<body>

<header>
    <img src="https://makroengenharia.com.br/wp-content/uploads/2023/03/logo-1.png" style="max-width: 120px;">
    <div style="font-size: 0.6rem; letter-spacing: 3px; opacity: 0.6; margin-top: 5px;">NPS | MAKRO ENGENHARIA</div>
</header>

<div class="container">
    <div class="view active" id="view-login">
        <div class="card" style="max-width: 350px; margin: 50px auto;">
            <h2 style="text-align: center; margin-bottom: 20px; font-weight: 900;">Acesso BI</h2>
            <input type="text" id="user-login" placeholder="E-mail corporativo">
            <input type="password" id="user-pass" placeholder="Senha">
            <button class="btn" id="btnLogin" onclick="autenticar()">Entrar</button>
        </div>
    </div>

    <div class="view" id="view-adm">
        <div class="card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h3 id="adm-welcome" style="font-size: 0.9rem;">Painel de Indicadores</h3>
                <button onclick="location.reload()" style="background:none; border:none; color:white; cursor:pointer; font-size: 10px; opacity: 0.5;">SAIR ↳</button>
            </div>
            
            <div class="filter-group">
                <div><label>Mês</label><select id="f-mes" onchange="aplicarFiltros()"><option value="Todos">Todos</option></select></div>
                <div><label>Unidade</label><select id="f-unidade" onchange="aplicarFiltros()"><option value="Todas">Todas</option></select></div>
                <div><label>Cliente</label><select id="f-cliente" onchange="aplicarFiltros()"><option value="Todos">Todos</option></select></div>
                <div><label>Contrato</label><select id="f-contrato" onchange="aplicarFiltros()"><option value="Todos">Todos</option></select></div>
            </div>

            <div class="grid-metrics">
                <div class="card-metric"><span>Total</span><h2 id="m-total">0</h2></div>
                <div class="card-metric" style="color:var(--verde-nps)"><span>Promotores</span><h2 id="m-promotores">0</h2></div>
                <div class="card-metric" style="color:var(--vermelho-nps)"><span>Detratores</span><h2 id="m-detratores">0</h2></div>
                <div class="card-metric" id="card-nps-total"><span>NPS Score</span><h2 id="m-nps">0</h2></div>
            </div>

            <div style="height: 300px;"><canvas id="npsChart"></canvas></div>
        </div>
    </div>

    <div class="view" id="view-cliente">
        <div class="card">
            <h2 id="msg-cliente">Olá!</h2>
            <form id="pesquisaMakro">
                <label>Mês de Referência</label>
                <select name="Mes Referente" required>
                    <option value="Jan 26">Jan 26</option><option value="Fev 26" selected>Fev 26</option><option value="Mar 26">Mar 26</option>
                </select>
                
                <label>Contrato</label>
                <select id="select-contrato" name="Nome do Contrato" onchange="vincularCodigo(this.value)" required></select>
                
                <label>Número do Contrato</label>
                <input type="text" name="Número do Contrato" id="input-num-contrato" readonly style="opacity: 0.5;">

                <label>Sua Nota (0 a 10)</label>
                <div class="nps-container">
                    <script>for(let i=0;i<=10;i++) document.write(`<div class="nps-item" style="flex:1"><input type="radio" name="Nota" id="n${i}" value="${i}" ${i==10?'checked':''}><label for="n${i}">${i}</label></div>`);</script>
                </div>

                <label>Feedback</label>
                <textarea name="Feedback" rows="3" placeholder="Sua opinião..."></textarea>
                
                <input type="hidden" name="Nome do Cliente" id="h-cliente">
                <input type="hidden" name="Email do Responsável" id="h-email">
                <input type="hidden" name="Nome do Responsável" id="h-nome">
                <button type="submit" class="btn" id="btnSubmit" style="margin-top: 15px;">Enviar Avaliação</button>
            </form>
        </div>
    </div>
</div>

<footer>MAKRO ENGENHARIA © 2026</footer>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwcsfpw1_uglhD6JtF4jAvjJ4hqgnHTcgKL8CBtb_i6pRmck7POOBvuqYykjIIE9sLdyQ/exec';
    let dadosBrutos = [];
    let dbContratosGlobal = [];
    let meuGrafico = null;

    document.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            const activeView = document.querySelector('.view.active').id;
            if (activeView === 'view-login') autenticar();
        }
    });

    function autenticar() {
        const user = document.getElementById('user-login').value;
        const pass = document.getElementById('user-pass').value;
        const btn = document.getElementById('btnLogin');
        if(!user || !pass) return alert("Preencha os campos.");
        
        btn.innerText = "VALIDANDO..."; btn.disabled = true;

        fetch(`${scriptURL}?action=login&user=${encodeURIComponent(user)}&pass=${encodeURIComponent(pass)}`)
        .then(res => res.json()).then(res => {
            if(res.result === "success") {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                if(res.tipo === "ADM") {
                    dadosBrutos = res.metrics.baseDados;
                    document.getElementById('view-adm').classList.add('active');
                    popularSelect('f-mes', [...new Set(dadosBrutos.map(d => d.mes))]);
                    popularSelect('f-unidade', res.metrics.unidades);
                    popularSelect('f-cliente', res.metrics.clientes);
                    popularSelect('f-contrato', [...new Set(dadosBrutos.map(d => d.contrato))]);
                    aplicarFiltros();
                } else {
                    document.getElementById('view-cliente').classList.add('active');
                    document.getElementById('msg-cliente').innerText = `Olá, ${res.nome}!`;
                    document.getElementById('h-cliente').value = res.nome;
                    document.getElementById('h-email').value = user;
                    document.getElementById('h-nome').value = res.nome;
                    dbContratosGlobal = res.metrics ? res.metrics.listaContratos : [];
                    document.getElementById('select-contrato').innerHTML = res.contratos.map(c => `<option value="${c.trim()}">${c.trim()}</option>`).join('');
                    vincularCodigo(res.contratos[0].trim());
                }
            } else { 
                alert("Acesso negado."); 
                btn.innerText = "Entrar"; btn.disabled = false;
            }
        }).catch(err => {
            alert("Erro de conexão.");
            btn.innerText = "Entrar"; btn.disabled = false;
        });
    }

    function vincularCodigo(nome) {
        const contrato = dbContratosGlobal.find(c => c.nome === nome);
        if(contrato) document.getElementById('input-num-contrato').value = contrato.numero;
    }

    function popularSelect(id, lista) {
        const s = document.getElementById(id);
        const prefixo = (id === 'f-unidade') ? 'Todas' : (id === 'f-mes' || id === 'f-contrato' || id === 'f-cliente') ? 'Todos' : '';
        s.innerHTML = `<option value="${prefixo}">${prefixo}</option>`;
        lista.sort().forEach(item => { if(item) s.innerHTML += `<option value="${item}">${item}</option>`; });
    }

    function aplicarFiltros() {
        const m = document.getElementById('f-mes').value;
        const u = document.getElementById('f-unidade').value;
        const cl = document.getElementById('f-cliente').value;
        const ct = document.getElementById('f-contrato').value;

        const filtrados = dadosBrutos.filter(d => 
            (m === "Todos" || d.mes === m) && (u === "Todas" || d.unidade === u) &&
            (cl === "Todos" || d.cliente === cl) && (ct === "Todos" || d.contrato === ct)
        );

        const t = filtrados.length;
        const p = filtrados.filter(x => x.nota >= 9).length;
        const det = filtrados.filter(x => x.nota <= 6).length;
        const nps = t > 0 ? Math.round(((p - det) / t) * 100) : 0;

        document.getElementById('m-total').innerText = t;
        document.getElementById('m-promotores').innerText = p;
        document.getElementById('m-detratores').innerText = det;
        document.getElementById('m-nps').innerText = nps;
        
        const cor = nps >= 75 ? '#007bff' : nps >= 50 ? '#28a745' : nps >= 0 ? '#FF8C00' : '#ED1C24';
        document.getElementById('card-nps-total').style.backgroundColor = cor;

        renderizarGrafico(filtrados);
    }

    function renderizarGrafico(dados) {
        const mesesMestre = ["Jan 25", "Fev 25", "Mar 25", "Abr 25", "Mai 25", "Jun 25", "Jul 25", "Ago 25", "Set 25", "Out 25", "Nov 25", "Dez 25", "Jan 26", "Fev 26", "Mar 26"];
        const labels = mesesMestre.filter(m => dadosBrutos.some(d => d.mes === m));
        const scores = labels.map(m => {
            const dMes = dados.filter(x => x.mes === m);
            if(dMes.length === 0) return 0;
            const p = dMes.filter(x => x.nota >= 9).length;
            const det = dMes.filter(x => x.nota <= 6).length;
            return Math.round(((p - det) / dMes.length) * 100);
        });

        if(meuGrafico) meuGrafico.destroy();
        
        // Registrando o plugin de datalabels para exibir os números nas barras
        Chart.register(ChartDataLabels);

        meuGrafico = new Chart(document.getElementById('npsChart'), {
            type: 'bar',
            data: { 
                labels: labels, 
                datasets: [{ 
                    data: scores, 
                    backgroundColor: scores.map(s => s >= 75 ? '#007bff' : s >= 50 ? '#28a745' : s >= 0 ? '#FF8C00' : '#ED1C24'), 
                    borderRadius: 5 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false },
                    // Configuração dos números sobre as barras
                    datalabels: {
                        color: '#fff',
                        anchor: 'end',
                        align: 'top',
                        offset: -2,
                        font: { weight: 'bold', size: 10 },
                        formatter: (value) => value // Exibe o valor numérico puro
                    }
                }, 
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        min: -100, 
                        max: 120, // Aumentado para dar espaço ao rótulo no topo
                        ticks: { color: '#fff' } 
                    }, 
                    x: { ticks: { color: '#fff' } } 
                } 
            }
        });
    }

    document.getElementById('pesquisaMakro').addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        btn.disabled = true; btn.innerText = 'ENVIANDO...';
        fetch(`${scriptURL}?action=survey&${new URLSearchParams(new FormData(e.target)).toString()}`, { method: 'POST' })
        .then(() => { alert('Feedback enviado!'); location.reload(); });
    });
</script>
</body>
</html>
